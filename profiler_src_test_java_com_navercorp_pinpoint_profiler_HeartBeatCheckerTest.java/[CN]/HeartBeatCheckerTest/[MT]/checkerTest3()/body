{
  AtomicInteger requestCount=new AtomicInteger();
  AtomicInteger successCount=new AtomicInteger();
  ResponseServerMessageListener serverListener=new ResponseServerMessageListener(requestCount,successCount);
  PinpointSocketFactory socketFactory=createPinpointSocketFactory();
  PinpointSocket socket=createPinpointSocket(HOST,PORT,socketFactory);
  TcpDataSender sender=new TcpDataSender(socket);
  HeartBeatChecker checker=new HeartBeatChecker(sender,1000L,getAgentInfo());
  try {
    checker.start();
    createAndDeleteServer(serverListener,10000L);
    Thread.sleep(1000);
    createAndDeleteServer(serverListener,10000L);
    Thread.sleep(1000);
    createAndDeleteServer(serverListener,10000L);
    Assert.assertEquals(3,successCount.get());
  }
  finally {
    closeAll(null,checker,socket,socketFactory);
  }
}
