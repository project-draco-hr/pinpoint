{
  AtomicInteger requestCount=new AtomicInteger();
  AtomicInteger successCount=new AtomicInteger();
  ResponseServerMessageListener serverListener=new ResponseServerMessageListener(requestCount,successCount);
  PinpointServerSocket server=createServer(serverListener);
  PinpointSocketFactory socketFactory=createPinpointSocketFactory();
  PinpointSocket socket=createPinpointSocket(HOST,PORT,socketFactory);
  TcpDataSender sender=new TcpDataSender(socket);
  HeartBeatChecker checker=new HeartBeatChecker(sender,1000L,getAgentInfo());
  try {
    checker.start();
    Thread.sleep(10000);
    Assert.assertEquals(1,successCount.get());
  }
  finally {
    closeAll(server,checker,socket,socketFactory);
  }
}
