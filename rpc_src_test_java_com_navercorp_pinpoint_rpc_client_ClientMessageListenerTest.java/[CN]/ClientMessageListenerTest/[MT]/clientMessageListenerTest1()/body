{
  PinpointServerSocket serverSocket=PinpointRPCTestUtils.createServerSocket(bindPort,new AlwaysHandshakeSuccessListener());
  EchoClientListener echoMessageListener=new EchoClientListener();
  PinpointSocketFactory clientSocketFactory=PinpointRPCTestUtils.createSocketFactory(PinpointRPCTestUtils.getParams(),echoMessageListener);
  try {
    PinpointSocket socket=clientSocketFactory.connect("127.0.0.1",bindPort);
    Thread.sleep(500);
    List<ChannelContext> channelContextList=serverSocket.getDuplexCommunicationChannelContext();
    if (channelContextList.size() != 1) {
      Assert.fail();
    }
    ChannelContext channelContext=channelContextList.get(0);
    assertSendMessage(channelContextList.get(0),"simple",echoMessageListener);
    assertRequestMessage(channelContext,"request",echoMessageListener);
    PinpointRPCTestUtils.close(socket);
  }
  finally {
    clientSocketFactory.release();
    PinpointRPCTestUtils.close(serverSocket);
  }
}
