{
  PinpointServerAcceptor serverAcceptor=createServerFactory(new TestSeverMessageListener(),null);
  serverAcceptor.bind("localhost",bindPort);
  SimpleStreamBO bo=new SimpleStreamBO();
  PinpointSocketFactory pinpointSocketFactory=createSocketFactory(new TestListener(),new ServerListener(bo));
  PinpointSocket socket=pinpointSocketFactory.connect("127.0.0.1",bindPort);
  try {
    Thread.sleep(100);
    List<PinpointServer> writableServerList=serverAcceptor.getWritableServerList();
    Assert.assertEquals(1,writableServerList.size());
    PinpointServer writableServer=writableServerList.get(0);
    RecordedStreamChannelMessageListener clientListener=new RecordedStreamChannelMessageListener(4);
    ClientStreamChannelContext clientContext=writableServer.createStream(new byte[0],clientListener);
    StreamChannelContext aaa=socket.findStreamChannel(2);
    aaa.getStreamChannel().close();
    sendRandomBytes(bo);
    Thread.sleep(100);
    clientContext.getStreamChannel().close();
  }
  finally {
    PinpointRPCTestUtils.close(socket);
    pinpointSocketFactory.release();
    PinpointRPCTestUtils.close(serverAcceptor);
  }
}
