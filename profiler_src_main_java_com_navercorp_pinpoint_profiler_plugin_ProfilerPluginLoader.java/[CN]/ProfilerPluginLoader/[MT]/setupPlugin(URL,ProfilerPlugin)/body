{
  final ClassInjector classInjector=JarProfilerPluginClassInjector.of(agent.getInstrumentation(),agent.getClassPool(),jar);
  final DefaultProfilerPluginContext context=new DefaultProfilerPluginContext(agent,classInjector);
  final GuardProfilerPluginContext guard=new GuardProfilerPluginContext(context);
  try {
    plugin.setup(guard);
  }
  finally {
    guard.close();
  }
  return context;
}
