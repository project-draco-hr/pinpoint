{
  final ClassInjector classInjector=JarProfilerPluginClassInjector.of(agent.getInstrumentation(),agent.getClassPool(),jar);
  final DefaultProfilerPluginContext context=new DefaultProfilerPluginContext(agent,classInjector);
  final GuardProfilerPluginContext guardPluginContext=new GuardProfilerPluginContext(context);
  final GuardInstrumentContext guardInstrumentContext=preparePlugin(plugin,context);
  try {
    plugin.setup(guardPluginContext);
  }
  finally {
    guardPluginContext.close();
    guardInstrumentContext.close();
  }
  return context;
}
