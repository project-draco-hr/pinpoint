{
  checkBeforeTraceObject();
  final boolean sampling=sampler.isSampling();
  if (sampling) {
    final DefaultTrace trace=new DefaultTrace(traceContext,nextTransactionId());
    final TraceId traceId=trace.getTraceId();
    traceId.incrementTraceCount();
    final Storage storage=storagePool.getStorage(traceId);
    trace.setStorage(storage);
    trace.setSampling(sampling);
    threadLocal.set(trace);
    return trace;
  }
 else {
    final Trace metricTrace=createMetricTrace();
    threadLocal.set(metricTrace);
    return metricTrace;
  }
}
