{
  if (built)   return this;
  Map<String,Set<AgentInfoBo>> agentMap=new HashMap<String,Set<AgentInfoBo>>();
  for (  TransactionFlowStatistics stat : data) {
    if (stat.getToAgentSet() != null) {
      String key=makeApplicationId(stat.getTo(),stat.getToServiceType());
      if (agentMap.containsKey(key)) {
        agentMap.get(key).addAll(stat.getToAgentSet());
      }
 else {
        agentMap.put(key,stat.getToAgentSet());
      }
    }
  }
  for (  TransactionFlowStatistics stat : data) {
    if (!stat.getFromServiceType().isRpcClient()) {
      addApplication(new Application(makeApplicationId(stat.getFrom(),stat.getFromServiceType()),stat.getFrom(),stat.getFromServiceType(),null,agentMap.get(makeApplicationId(stat.getFrom(),stat.getFromServiceType()))));
    }
    if (!stat.getToServiceType().isRpcClient()) {
      addApplication(new Application(makeApplicationId(stat.getTo(),stat.getToServiceType()),stat.getTo(),stat.getToServiceType(),stat.getToHostList(),null));
    }
    if (!applicationNames.contains(stat.getTo())) {
      addApplication(new Application(makeApplicationId(stat.getTo(),stat.getToServiceType()),stat.getTo(),stat.getToServiceType(),stat.getToHostList(),agentMap.get(makeApplicationId(stat.getFrom(),stat.getFromServiceType()))));
    }
  }
  int index=0;
  for (  Entry<String,Application> entry : applications.entrySet()) {
    entry.getValue().setSequence(index++);
  }
  for (  TransactionFlowStatistics stat : data) {
    Application from=findApplication(stat.getFrom(),stat.getFromServiceType());
    Application to=findApplication(stat.getTo(),stat.getToServiceType());
    if (to == null) {
      continue;
    }
    if (to.getServiceType().isRpcClient()) {
      if (!applicationNames.contains(to.getApplicationName())) {
        addRelation(new ApplicationRelation(from,to,stat.getToHostList()));
      }
    }
 else {
      addRelation(new ApplicationRelation(from,to,stat.getToHostList()));
    }
  }
  built=true;
  return this;
}
