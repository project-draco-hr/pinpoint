{
  if (agentId == null) {
    throw new NullPointerException("agentId must not be null");
  }
  if (range == null) {
    throw new NullPointerException("range must not be null");
  }
  if (logger.isDebugEnabled()) {
    logger.debug("scanAgentStat : agentId={}, {}",agentId,range);
  }
  Scan scan=createScan(agentId,range);
  scan.addFamily(HBaseTables.AGENT_STAT_CF_STATISTICS);
  List<List<AgentStat>> intermediate=hbaseOperations2.find(HBaseTables.AGENT_STAT_AGGR,scan,rowKeyDistributor,agentStatMapper);
  List<AgentStat> merged=new ArrayList<>();
  for (  List<AgentStat> each : intermediate) {
    merged.addAll(each);
  }
  Collections.sort(merged,AgentStats.TIMESTAMP_COMPARATOR);
  List<Range> missingRanges=new ArrayList<>();
  long last=range.getFrom();
  for (  AgentStat stat : merged) {
    if (last + AgentStat.AGGR_SAMPLE_INTERVAL * 2 < stat.getTimestamp()) {
      Range r=new Range(last,stat.getTimestamp() - stat.getCollectInterval());
      missingRanges.add(r);
    }
    last=stat.getTimestamp();
  }
  if (last + AgentStat.AGGR_SAMPLE_INTERVAL * 2 < range.getTo()) {
    Range r=new Range(last,range.getTo());
    missingRanges.add(r);
  }
  for (  Range r : missingRanges) {
    logger.debug("AgentStatAggr doesn't have range: " + r.prettyToString() + " of "+ agentId);
    List<AgentStat> list=getAgentStatListFromRaw(agentId,r);
    if (list.isEmpty()) {
      logger.debug("AgentStat also doesn't have range: " + r.prettyToString() + " of "+ agentId);
      continue;
    }
    List<AgentStat> aggregated=AgentStats.aggregate(list,AgentStat.AGGR_SAMPLE_INTERVAL);
    merged.addAll(aggregated);
  }
  return merged;
}
