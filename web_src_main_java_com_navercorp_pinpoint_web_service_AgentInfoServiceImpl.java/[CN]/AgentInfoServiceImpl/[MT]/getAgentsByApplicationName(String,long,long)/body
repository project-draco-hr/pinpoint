{
  if (applicationName == null) {
    throw new NullPointerException("applicationName must not be null");
  }
  if (timestamp < 0) {
    throw new IllegalArgumentException("timestamp must not be less than 0");
  }
  if (timeDiff > timestamp) {
    throw new IllegalArgumentException("timeDiff must not be greater than timestamp");
  }
  final long eventTimestampFloor=timestamp - timeDiff;
  List<String> agentIds=this.applicationIndexDao.selectAgentIds(applicationName);
  List<AgentInfo> unfilteredAgentInfos=this.agentInfoDao.getAgentInfos(agentIds,timestamp);
  if (unfilteredAgentInfos == null || unfilteredAgentInfos.isEmpty()) {
    return Collections.emptySet();
  }
  CollectionUtils.filter(unfilteredAgentInfos,PredicateUtils.notNullPredicate());
  this.agentLifeCycleDao.populateAgentStatuses(unfilteredAgentInfos,timestamp);
  Set<AgentInfo> filteredAgentInfos=new HashSet<>();
  for (  AgentInfo agentInfo : unfilteredAgentInfos) {
    AgentStatus agentStatus=agentInfo.getStatus();
    if (AgentLifeCycleState.UNKNOWN == agentStatus.getState() || eventTimestampFloor <= agentStatus.getEventTimestamp()) {
      filteredAgentInfos.add(agentInfo);
    }
  }
  return filteredAgentInfos;
}
