{
  assert(tbase instanceof Span);
  try {
    Span span=(Span)tbase;
    if (logger.isInfoEnabled()) {
      logger.info("Received SPAN={}",span);
    }
    String applicationName=agentIdApplicationIndexDao.selectApplicationName(span.getAgentId());
    if (applicationName == null) {
      logger.warn("Applicationname '{}' not found. Drop the log.",applicationName);
      return;
    }
 else {
      logger.info("Applicationname '{}' found. Write the log.",applicationName);
    }
    traceDao.insert(applicationName,span);
    ServiceType serviceType=ServiceType.parse(span.getServiceType());
    if (serviceType.isIndexable()) {
      traceIndexDao.insert(span);
      applicationTraceIndexDao.insert(applicationName,span);
      businessTransactionStatistics.update(applicationName,span);
    }
 else {
      logger.debug("Skip writing index. '{}'",span);
    }
    List<SubSpan> subSpanList=span.getSubSpanList();
    if (subSpanList != null) {
      logger.info("handle subSpan size:{}",subSpanList.size());
      for (      SubSpan subSpan : subSpanList) {
        ServiceType subSpanServiceType=ServiceType.parse(subSpan.getServiceType());
        if (subSpanServiceType == ServiceType.INTERNAL_METHOD) {
          continue;
        }
        int elapsed=subSpan.getEndElapsed();
        boolean hasException=SubSpanUtils.hasException(subSpan);
        if (subSpanServiceType.isRpcClient()) {
          terminalStatistics.update(applicationName,subSpan.getEndPoint(),serviceType.getCode(),elapsed,hasException);
        }
 else {
          terminalStatistics.update(applicationName,subSpan.getServiceName(),serviceType.getCode(),elapsed,hasException);
        }
      }
    }
  }
 catch (  Exception e) {
    logger.warn("Span handle error " + e.getMessage(),e);
  }
}
