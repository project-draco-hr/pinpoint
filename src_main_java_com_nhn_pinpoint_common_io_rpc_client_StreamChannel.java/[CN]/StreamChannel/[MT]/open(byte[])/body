{
  if (!state.compareAndSet(NONE,OPEN)) {
    throw new IllegalStateException("invalid state:" + state.get());
  }
  StreamCreatePacket streamCreatePacket=new StreamCreatePacket(channelId,bytes);
  this.openLatch=new DefaultFuture<StreamCreateResponse>();
  openLatch.setFailureEventHandler(new FailureEventHandler(){
    @Override public boolean fireFailure(){
      streamChannelManager.closeChannel(channelId);
      return false;
    }
  }
);
  ChannelFuture channelFuture=this.channel.write(streamCreatePacket);
  channelFuture.addListener(new ChannelFutureListener(){
    @Override public void operationComplete(    ChannelFuture future) throws Exception {
      if (!future.isSuccess()) {
        future.setFailure(future.getCause());
      }
    }
  }
);
  if (!state.compareAndSet(OPEN,OPEN_AWAIT)) {
    throw new IllegalStateException("invalid state");
  }
  return openLatch;
}
