{
  List<TestSocket> socketList=new ArrayList<ZookeeperProfilerClusterStressTest.TestSocket>();
  PinpointServerSocket pinpointServerSocket=null;
  TestingServer ts=null;
  try {
    ts=ZookeeperTestUtils.createZookeeperServer(DEFAULT_ACCEPTOR_PORT);
    ZookeeperClusterService service=new ZookeeperClusterService(collectorConfig,clusterPointRouter);
    service.setUp();
    ZookeeperProfilerClusterManager profiler=service.getProfilerClusterManager();
    pinpointServerSocket=new PinpointServerSocket(service.getChannelStateChangeEventListener());
    pinpointServerSocket.setMessageListener(ZookeeperTestUtils.getServerMessageListener());
    pinpointServerSocket.bind("127.0.0.1",DEFAULT_ACCEPTOR_SOCKET_PORT);
    InetSocketAddress address=new InetSocketAddress("127.0.0.1",DEFAULT_ACCEPTOR_SOCKET_PORT);
    socketList=connectPoint(socketList,address,doCount);
    Thread.sleep(1000);
    Assert.assertEquals(socketList.size(),profiler.getClusterData().size());
    for (int i=0; i < doCount; i++) {
      socketList=randomJob(socketList,address);
      Thread.sleep(1000);
      Assert.assertEquals(socketList.size(),profiler.getClusterData().size());
    }
    disconnectPoint(socketList,socketList.size());
    Thread.sleep(1000);
    Assert.assertEquals(0,profiler.getClusterData().size());
    service.tearDown();
  }
  finally {
    closeZookeeperServer(ts);
    pinpointServerSocket.close();
  }
}
