{
  final AtomicInteger requestCount=new AtomicInteger();
  final AtomicInteger successCount=new AtomicInteger();
  final long agentInfoSendRetryIntervalMs=1000L;
  final long minimumAgentInfoSendRetryCount=10;
  ResponseServerMessageListener serverListener=new ResponseServerMessageListener(requestCount,successCount,Integer.MAX_VALUE);
  PinpointServerAcceptor serverAcceptor=createServerAcceptor(serverListener);
  PinpointClientFactory socketFactory=createPinpointClientFactory();
  PinpointClient pinpointClient=createPinpointClient(HOST,PORT,socketFactory);
  TcpDataSender dataSender=new TcpDataSender(pinpointClient);
  AgentInfoSender agentInfoSender=new AgentInfoSender(dataSender,agentInfoSendRetryIntervalMs,getAgentInfo());
  try {
    agentInfoSender.start();
    Thread.sleep(agentInfoSendRetryIntervalMs * minimumAgentInfoSendRetryCount);
  }
  finally {
    closeAll(serverAcceptor,agentInfoSender,pinpointClient,socketFactory);
  }
  assertTrue(requestCount.get() >= minimumAgentInfoSendRetryCount);
  assertEquals(0,successCount.get());
}
