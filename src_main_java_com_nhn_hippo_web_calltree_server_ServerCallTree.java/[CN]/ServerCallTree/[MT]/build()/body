{
  if (isBuilt)   return this;
  for (  Entry<String,TerminalStatistics> entry : terminalRequests.entrySet()) {
    TerminalStatistics terminal=entry.getValue();
    Server server=new Server(terminal.getTo(),terminal.getTo(),terminal.getHosts(),ServiceType.findServiceType(terminal.getToServiceType()));
    servers.put(server.getId(),server);
  }
  for (  Entry<String,ClientStatistics> entry : clientRequests.entrySet()) {
    ClientStatistics client=entry.getValue();
    Server server=new Server(client.getId(),client.getTo(),null,ServiceType.findServiceType(client.getToServiceType()));
    servers.put(server.getId(),server);
  }
  int i=0;
  for (  Entry<String,Server> entry : servers.entrySet()) {
    entry.getValue().setSequence(i++);
  }
  for (  Entry<String,TerminalStatistics> entry : terminalRequests.entrySet()) {
    TerminalStatistics terminal=entry.getValue();
    ServerRequest request=new ServerRequest(servers.get(terminal.getFrom()),servers.get(terminal.getTo()),terminal.getHistogram());
    serverRequests.put(request.getId(),request);
  }
  for (  SpanBo span : spans) {
    String from=String.valueOf(span.getParentSpanId());
    String to=String.valueOf(span.getSpanId());
    logger.debug("add non-terminal requests from=" + from + ", to="+ to);
    Server fromServer=servers.get((span.isRoot()) ? clientServerMap.get(span.getApplicationId()) : spanIdToServerId.get(from));
    Server toServer=servers.get(spanIdToServerId.get(to));
    if (fromServer == null) {
      logger.debug("invalid fromServer {}",from);
      continue;
    }
    ServerRequest serverRequest=new ServerRequest(fromServer,toServer,new ResponseHistogram(span.isRoot() ? ServiceType.CLIENT : span.getServiceType()));
    if (serverRequests.containsKey(serverRequest.getId())) {
      serverRequests.get(serverRequest.getId()).getHistogram().addSample(span.getElapsed());
    }
 else {
      serverRequest.getHistogram().addSample(span.getElapsed());
      serverRequests.put(serverRequest.getId(),serverRequest);
    }
  }
  for (  SpanEventBo spanEventBo : subspans) {
    String from=String.valueOf(spanEventBo.getSpanId());
    String to;
    to=spanEventBo.getDestinationId();
    Server fromServer=servers.get(spanIdToServerId.get(from));
    Server toServer=servers.get(spanIdToServerId.get(to));
    ResponseHistogram histogram=new ResponseHistogram(spanEventBo.getServiceType());
    histogram.addSample(spanEventBo.getEndElapsed());
    ServerRequest serverRequest=new ServerRequest(fromServer,toServer,histogram);
    if (serverRequests.containsKey(serverRequest.getId())) {
      serverRequests.get(serverRequest.getId()).getHistogram().addSample(spanEventBo.getEndElapsed());
    }
 else {
      serverRequests.put(serverRequest.getId(),serverRequest);
    }
  }
  isBuilt=true;
  return this;
}
