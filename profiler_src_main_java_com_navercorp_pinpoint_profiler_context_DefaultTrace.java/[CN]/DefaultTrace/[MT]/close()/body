{
  if (closed) {
    logger.warn("Already closed trace.");
    return;
  }
  closed=true;
  if (!callStack.empty()) {
    PinpointException exception=new PinpointException("Corrupted CallStack found");
    logger.warn("Corrupted CallStack found. stack is not empty.",exception);
  }
 else {
    Span span=spanRecorder.getSpan();
    span.markAfterTime();
    logSpan(span);
  }
  if (this.storage != null) {
    this.traceId.decrementTraceCount();
    this.storage.close();
    this.storage=null;
  }
}
