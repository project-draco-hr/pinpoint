{
  if (!(tbase instanceof TSpan)) {
    throw new IllegalArgumentException("unexpected tbase:" + tbase + " expected:"+ this.getClass().getName());
  }
  try {
    TSpan span=(TSpan)tbase;
    if (logger.isDebugEnabled()) {
      logger.debug("Received SPAN={}",span);
    }
    traceDao.insert(span);
    applicationTraceIndexDao.insert(span);
    statisticsHandler.updateApplication(span.getApplicationName(),span.getServiceType(),span.getAgentId(),span.getElapsed(),span.getErr() > 0);
    if (span.getParentSpanId() == -1) {
      statisticsHandler.updateCallee(span.getApplicationName(),span.getServiceType(),span.getApplicationName(),ServiceType.CLIENT.getCode(),span.getAgentId(),span.getElapsed(),span.getErr() > 0);
      statisticsHandler.updateCaller(span.getApplicationName(),ServiceType.CLIENT.getCode(),span.getApplicationName(),span.getServiceType(),span.getAgentId(),span.getElapsed(),span.getErr() > 0);
    }
    if (span.getParentApplicationName() != null) {
      logger.debug("Received parent application name. {}",span.getParentApplicationName());
      statisticsHandler.updateCaller(span.getParentApplicationName(),span.getParentApplicationType(),span.getApplicationName(),span.getServiceType(),span.getAgentId(),span.getElapsed(),span.getErr() > 0);
    }
    if (span.getAcceptorHost() != null) {
      hostApplicationMapDao.insert(span.getAcceptorHost(),span.getApplicationName(),span.getServiceType());
    }
    List<TSpanEvent> spanEventList=span.getSpanEventList();
    if (spanEventList != null) {
      logger.debug("handle spanEvent size:{}",spanEventList.size());
      for (      TSpanEvent spanEvent : spanEventList) {
        ServiceType serviceType=ServiceType.findServiceType(spanEvent.getServiceType());
        if (!serviceType.isRecordStatistics()) {
          continue;
        }
        int elapsed=spanEvent.getEndElapsed();
        boolean hasException=SpanEventUtils.hasException(spanEvent);
        statisticsHandler.updateApplication(spanEvent.getDestinationId(),serviceType.getCode(),spanEvent.getEndPoint(),elapsed,hasException);
        statisticsHandler.updateCallee(spanEvent.getDestinationId(),serviceType.getCode(),span.getApplicationName(),span.getServiceType(),spanEvent.getEndPoint(),elapsed,hasException);
        statisticsHandler.updateCaller(span.getApplicationName(),span.getServiceType(),spanEvent.getDestinationId(),spanEvent.getServiceType(),span.getEndPoint(),elapsed,hasException);
      }
    }
  }
 catch (  Exception e) {
    logger.warn("Span handle error. Caused:{}. Span:{}",e.getMessage(),tbase,e);
  }
}
