{
  if (!(tbase instanceof TSpan)) {
    throw new IllegalArgumentException("unexpected tbase:" + tbase + " expected:"+ this.getClass().getName());
  }
  try {
    TSpan span=(TSpan)tbase;
    if (logger.isDebugEnabled()) {
      logger.debug("Received SPAN={}",span);
    }
    traceDao.insert(span);
    applicationTraceIndexDao.insert(span);
    if (span.getParentSpanId() == -1) {
      statisticsHandler.updateCallee(span.getApplicationName(),span.getServiceType(),span.getApplicationName(),ServiceType.USER.getCode(),span.getAgentId(),span.getElapsed(),span.getErr() > 0);
      statisticsHandler.updateCaller(span.getApplicationName(),ServiceType.USER.getCode(),span.getApplicationName(),span.getServiceType(),span.getAgentId(),span.getElapsed(),span.getErr() > 0);
    }
    if (span.getParentApplicationName() != null) {
      logger.debug("Received parent application name. {}",span.getParentApplicationName());
      statisticsHandler.updateCaller(span.getParentApplicationName(),span.getParentApplicationType(),span.getApplicationName(),span.getServiceType(),span.getAgentId(),span.getElapsed(),span.getErr() > 0);
    }
    insertAcceptorHost(span);
    insertStatistics(span);
  }
 catch (  Exception e) {
    logger.warn("Span handle error. Caused:{}. Span:{}",e.getMessage(),tbase,e);
  }
}
