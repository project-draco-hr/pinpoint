{
  checkBeforeTraceObject();
  final boolean sampling=this.sampler.isSampling();
  if (sampling) {
    DefaultTrace trace=new DefaultTrace(this.agentId,agentStartTime,transactionId.getAndIncrement());
    Storage storage=storageFactory.createStorage();
    trace.setStorage(storage);
    trace.setTraceContext(this);
    trace.setSampling(sampling);
    threadLocal.set(trace);
    return trace;
  }
 else {
    DisableTrace instance=DisableTrace.INSTANCE;
    threadLocal.set(instance);
    return instance;
  }
}
