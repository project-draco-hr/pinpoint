{
  int requestId=handshakepacket.getRequestId();
  Map<Object,Object> handshakeData=decodeHandshakePacket(handshakepacket);
  HandshakeResponseCode responseCode=messageListener.handleHandshake(handshakeData);
  boolean isFirst=setChannelProperties(handshakeData);
  if (isFirst) {
    if (HandshakeResponseCode.DUPLEX_COMMUNICATION == responseCode) {
      changeStateToRunDuplex(PinpointServerStateCode.RUN_DUPLEX);
    }
 else     if (HandshakeResponseCode.SIMPLEX_COMMUNICATION == responseCode) {
      changeStateToRunSimplex(PinpointServerStateCode.RUN_SIMPLEX);
    }
  }
  Map<String,Object> responseData=createHandshakeResponse(responseCode,isFirst);
  sendHandshakeResponse0(requestId,responseData);
}
