{
  PinpointServerSocket ss=new PinpointServerSocket();
  ss.bind("127.0.0.1",10234);
  EchoMessageListener echoMessageListener=new EchoMessageListener();
  PinpointSocketFactory socketFactory=createPinpointSocketFactory();
  socketFactory.setMessageListener(echoMessageListener);
  try {
    PinpointSocket socket=socketFactory.connect("127.0.0.1",10234);
    Thread.sleep(500);
    List<ChannelContext> channelContextList=ss.getDuplexCommunicationChannelContext();
    if (channelContextList.size() != 1) {
      Assert.fail();
    }
    ChannelContext channelContext=channelContextList.get(0);
    channelContext.getSocketChannel().sendMessage("simple".getBytes());
    Thread.sleep(100);
    Assert.assertEquals("simple",new String(echoMessageListener.getSendPacketRepository().get(0).getPayload()));
    Future<ResponseMessage> future=channelContext.getSocketChannel().sendRequestMessage("request".getBytes());
    future.await();
    ResponseMessage message=future.getResult();
    Assert.assertEquals("request",new String(message.getMessage()));
    Assert.assertEquals("request",new String(echoMessageListener.getRequestPacketRepository().get(0).getPayload()));
    socket.close();
  }
  finally {
    socketFactory.release();
    ss.close();
  }
}
