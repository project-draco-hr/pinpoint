{
  if (!(tbase instanceof TSpanEvent)) {
    throw new IllegalArgumentException("unexpected tbase:" + tbase + " expected:"+ this.getClass().getName());
  }
  try {
    TSpanEvent spanEvent=(TSpanEvent)tbase;
    if (logger.isDebugEnabled()) {
      logger.debug("Received SpanEvent={}",spanEvent);
    }
    String traceAgentId=spanEvent.getTraceAgentId();
    if (traceAgentId == null) {
      spanEvent.setTraceAgentId(spanEvent.getAgentKey().getAgentId());
    }
    traceDao.insertEvent(spanEvent);
    ServiceType serviceType=ServiceType.findServiceType(spanEvent.getServiceType());
    if (!serviceType.isRecordStatistics()) {
      return;
    }
    int elapsed=spanEvent.getEndElapsed();
    boolean hasException=SpanEventUtils.hasException(spanEvent);
    statisticsHandler.updateApplication(spanEvent.getDestinationId(),serviceType.getCode(),spanEvent.getEndPoint(),elapsed,hasException);
    statisticsHandler.updateCallee(spanEvent.getDestinationId(),serviceType.getCode(),spanEvent.getAgentKey().getApplicationName(),spanEvent.getParentServiceType(),spanEvent.getEndPoint(),elapsed,hasException);
    statisticsHandler.updateCaller(spanEvent.getAgentKey().getApplicationName(),spanEvent.getParentServiceType(),spanEvent.getDestinationId(),spanEvent.getServiceType(),spanEvent.getParentEndPoint(),elapsed,hasException);
  }
 catch (  Exception e) {
    logger.warn("SpanEvent handle error. Caused:{} ",e.getMessage(),e);
  }
}
