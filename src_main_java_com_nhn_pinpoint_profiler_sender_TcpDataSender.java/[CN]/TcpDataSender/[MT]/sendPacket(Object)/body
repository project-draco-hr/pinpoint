{
  TBase<?,?> tBase;
  boolean request=false;
  if (dto instanceof Thriftable) {
    tBase=((Thriftable)dto).toThrift();
  }
 else   if (dto instanceof TBase) {
    tBase=(TBase<?,?>)dto;
  }
 else   if (dto instanceof RequestMarker) {
    tBase=((RequestMarker)dto).getTBase();
    request=true;
  }
 else {
    logger.error("sendPacket fail. invalid dto type:{}",dto.getClass());
    return;
  }
  byte[] copy=serialize(tBase);
  if (copy == null) {
    return;
  }
  try {
    if (request) {
      doRequest(copy,0);
    }
 else {
      doSend(copy);
    }
  }
 catch (  Exception e) {
    logger.warn("tcp send fail. Caused:{}",e.getMessage(),e);
  }
}
