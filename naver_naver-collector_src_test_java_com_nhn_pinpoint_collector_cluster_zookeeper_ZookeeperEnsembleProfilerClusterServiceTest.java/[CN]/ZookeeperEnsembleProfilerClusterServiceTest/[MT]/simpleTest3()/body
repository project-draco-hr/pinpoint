{
  TestingCluster tcluster=null;
  try {
    tcluster=createZookeeperCluster(3);
    String connectString=getConnectString(tcluster);
    CollectorConfiguration collectorConfig=createConfig(connectString);
    ZookeeperClusterService service=new ZookeeperClusterService(collectorConfig,clusterPointRouter);
    service.setUp();
    ChannelContext channelContext=new ChannelContext(mock(SocketChannel.class),null,service.getChannelStateChangeEventListener());
    channelContext.setChannelProperties(getParams());
    ZookeeperProfilerClusterManager profilerClusterManager=service.getProfilerClusterManager();
    channelContext.changeStateRun();
    Thread.sleep(1000);
    List<String> result=profilerClusterManager.getClusterData();
    Assert.assertEquals(0,result.size());
    channelContext.changeStateRunDuplexCommunication();
    Thread.sleep(1000);
    result=profilerClusterManager.getClusterData();
    Assert.assertEquals(1,result.size());
    stop(tcluster);
    result=profilerClusterManager.getClusterData();
    Assert.assertEquals(0,result.size());
    restart(tcluster);
    result=profilerClusterManager.getClusterData();
    Assert.assertEquals(1,result.size());
    channelContext.changeStateShutdown();
    Thread.sleep(1000);
    result=profilerClusterManager.getClusterData();
    Assert.assertEquals(0,result.size());
    service.tearDown();
  }
  finally {
    closeZookeeperCluster(tcluster);
  }
}
