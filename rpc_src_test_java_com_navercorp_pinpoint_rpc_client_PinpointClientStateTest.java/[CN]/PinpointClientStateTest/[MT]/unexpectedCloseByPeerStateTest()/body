{
  PinpointServerAcceptor serverAcceptor=null;
  PinpointClientFactory clientFactory=null;
  DefaultPinpointClientHandler handler=null;
  try {
    serverAcceptor=PinpointRPCTestUtils.createPinpointServerFactory(bindPort,PinpointRPCTestUtils.createEchoServerListener());
    clientFactory=PinpointRPCTestUtils.createClientFactory(PinpointRPCTestUtils.getParams(),PinpointRPCTestUtils.createEchoClientListener());
    handler=connect(clientFactory);
    Thread.sleep(1000);
    List<PinpointSocket> pinpointServerList=serverAcceptor.getWritableSocketList();
    PinpointSocket pinpointServer=pinpointServerList.get(0);
    Assert.assertEquals(SocketStateCode.RUN_DUPLEX,handler.getCurrentStateCode());
    ((DefaultPinpointServer)pinpointServer).stop(true);
    Thread.sleep(1000);
    Assert.assertEquals(SocketStateCode.UNEXPECTED_CLOSE_BY_SERVER,handler.getCurrentStateCode());
  }
  finally {
    closeHandler(handler);
    closeSocketFactory(clientFactory);
    PinpointRPCTestUtils.close(serverAcceptor);
  }
}
