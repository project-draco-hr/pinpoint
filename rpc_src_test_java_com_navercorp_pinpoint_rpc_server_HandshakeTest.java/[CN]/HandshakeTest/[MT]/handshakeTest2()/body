{
  PinpointServerSocket serverSocket=PinpointRPCTestUtils.createServerSocket(bindPort,new AlwaysHandshakeSuccessListener());
  Map params=PinpointRPCTestUtils.getParams();
  PinpointSocketFactory clientSocketFactory1=PinpointRPCTestUtils.createSocketFactory(PinpointRPCTestUtils.getParams(),PinpointRPCTestUtils.createEchoClientListener());
  try {
    PinpointSocket socket=clientSocketFactory1.connect("127.0.0.1",bindPort);
    Thread.sleep(500);
    ChannelContext channelContext=getChannelContext("application","agent",(Long)params.get(AgentHandshakePropertyType.START_TIMESTAMP.getName()),serverSocket.getDuplexCommunicationChannelContext());
    Assert.assertNotNull(channelContext);
    channelContext=getChannelContext("application","agent",(Long)params.get(AgentHandshakePropertyType.START_TIMESTAMP.getName()) + 1,serverSocket.getDuplexCommunicationChannelContext());
    Assert.assertNull(channelContext);
    PinpointRPCTestUtils.close(socket);
  }
  finally {
    clientSocketFactory1.release();
    PinpointRPCTestUtils.close(serverSocket);
  }
}
