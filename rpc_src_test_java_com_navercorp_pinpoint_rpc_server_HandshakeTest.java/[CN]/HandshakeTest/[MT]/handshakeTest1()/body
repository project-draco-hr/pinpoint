{
  PinpointServerAcceptor serverAcceptor=PinpointRPCTestUtils.createPinpointServerFactory(bindPort,new AlwaysHandshakeSuccessListener());
  PinpointClientFactory clientFactory1=PinpointRPCTestUtils.createClientFactory(PinpointRPCTestUtils.getParams(),PinpointRPCTestUtils.createEchoClientListener());
  PinpointClientFactory clientFactory2=PinpointRPCTestUtils.createClientFactory(PinpointRPCTestUtils.getParams(),null);
  try {
    PinpointClient client=clientFactory1.connect("127.0.0.1",bindPort);
    PinpointClient client2=clientFactory2.connect("127.0.0.1",bindPort);
    Thread.sleep(500);
    List<PinpointServer> writableServerList=serverAcceptor.getWritableServerList();
    if (writableServerList.size() != 2) {
      Assert.fail();
    }
    PinpointRPCTestUtils.close(client,client2);
  }
  finally {
    clientFactory1.release();
    clientFactory2.release();
    PinpointRPCTestUtils.close(serverAcceptor);
  }
}
