{
  final Channel channel=e.getChannel();
  Object message=e.getMessage();
  logger.debug("messageReceived:{} channel:{}",message,channel);
  ChannelContext channelContext=getChannelContext(channel);
  if (!PinpointServerSocketStateCode.isRun(channelContext.getCurrentStateCode())) {
    logger.warn("MessageReceived:{} from IllegalState Channel:{} this message will be ignore.",message,channel);
    return;
  }
  final short packetType=getPacketType(message);
switch (packetType) {
case PacketType.APPLICATION_SEND:
{
      SocketChannel socketChannel=getChannelContext(channel).getSocketChannel();
      messageListener.handleSend((SendPacket)message,socketChannel);
      return;
    }
case PacketType.APPLICATION_REQUEST:
{
    SocketChannel socketChannel=getChannelContext(channel).getSocketChannel();
    messageListener.handleRequest((RequestPacket)message,socketChannel);
    return;
  }
case PacketType.APPLICATION_RESPONSE:
{
  SocketChannel socketChannel=getChannelContext(channel).getSocketChannel();
  socketChannel.receiveResponsePacket((ResponsePacket)message);
  return;
}
case PacketType.APPLICATION_STREAM_CREATE:
case PacketType.APPLICATION_STREAM_CLOSE:
case PacketType.APPLICATION_STREAM_CREATE_SUCCESS:
case PacketType.APPLICATION_STREAM_CREATE_FAIL:
case PacketType.APPLICATION_STREAM_RESPONSE:
case PacketType.APPLICATION_STREAM_PING:
case PacketType.APPLICATION_STREAM_PONG:
handleStreamPacket((StreamPacket)message,channel);
return;
case PacketType.CONTROL_HANDSHAKE:
int requestId=((ControlHandShakePacket)message).getRequestId();
Map<Object,Object> properties=decodeSocketProperties((ControlHandShakePacket)message);
if (properties == null) {
sendHandShakeResponseMessage(requestId,HandShakeResponseType.ProtocolError.PROTOCOL_ERROR,channel);
return;
}
HandShakeResponseCode code=messageListener.handleHandShake(properties);
if (code.getCode() != HandShakeResponseType.Success.CODE) {
sendHandShakeResponseMessage(requestId,code,channel);
}
 else {
boolean isSet=channelContext.setChannelProperties(properties);
if (isSet) {
if (code == HandShakeResponseCode.DUPLEX_COMMUNICATION) {
changeStateToRunDuplexCommunication(code,channel);
}
sendHandShakeResponseMessage(requestId,code,channel);
}
 else {
if (code == HandShakeResponseCode.DUPLEX_COMMUNICATION) {
sendHandShakeResponseMessage(requestId,HandShakeResponseCode.ALREADY_DUPLEX_COMMUNICATION,channel);
}
 else {
sendHandShakeResponseMessage(requestId,HandShakeResponseCode.ALREADY_SIMPLEX_COMMUNICATION,channel);
}
}
}
return;
case PacketType.CONTROL_CLIENT_CLOSE:
{
closeChannel(channel);
return;
}
default :
logger.warn("invalid messageReceived msg:{}, connection:{}",message,e.getChannel());
}
}
