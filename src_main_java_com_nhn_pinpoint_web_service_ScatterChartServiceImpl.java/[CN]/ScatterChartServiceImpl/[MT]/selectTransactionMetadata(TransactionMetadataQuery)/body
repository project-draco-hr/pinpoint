{
  if (query == null) {
    throw new NullPointerException("query must not be null");
  }
  final List<TransactionId> transactionIdList=query.getTransactionIdList();
  List<List<SpanBo>> selectedSpans=traceDao.selectSpans(transactionIdList);
  List<SpanBo> result=new ArrayList<SpanBo>(query.size());
  int index=0;
  for (  List<SpanBo> spans : selectedSpans) {
    if (spans.size() == 1) {
      result.add(spans.get(0));
    }
 else {
      final TransactionMetadataQuery.QueryCondition queryCondition=query.getIndex(index);
      for (      SpanBo span : spans) {
        final TransactionId transactionId=new TransactionId(span.getTraceAgentId(),span.getTraceAgentStartTime(),span.getTraceTransactionSequence());
        final TransactionMetadataQuery.QueryCondition key=new TransactionMetadataQuery.QueryCondition(transactionId,span.getCollectorAcceptTime(),span.getElapsed());
        if (queryCondition.equals(key)) {
          result.add(span);
        }
      }
    }
    index++;
  }
  return result;
}
