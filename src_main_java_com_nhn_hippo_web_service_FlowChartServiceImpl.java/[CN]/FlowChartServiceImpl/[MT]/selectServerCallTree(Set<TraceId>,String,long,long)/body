{
  final Map<String,ServiceType> terminalQueryParams=new HashMap<String,ServiceType>();
  final ServerCallTree tree=new ServerCallTree();
  StopWatch watch=new StopWatch();
  watch.start("scanNonTerminalSpans");
  List<List<SpanBo>> traces=this.traceDao.selectSpans(traceIds);
  watch.stop();
  int totalNonTerminalSpansCount=0;
  Set<String> endPoints=new HashSet<String>();
  for (  List<SpanBo> transaction : traces) {
    totalNonTerminalSpansCount+=transaction.size();
    markRecursiveCall(transaction);
    for (    SpanBo eachTransaction : transaction) {
      tree.addSpan(eachTransaction);
      terminalQueryParams.put(eachTransaction.getServiceName(),eachTransaction.getServiceType());
      endPoints.add(eachTransaction.getEndPoint());
    }
  }
  if (logger.isInfoEnabled()) {
    logger.info("Fetch non-terminal spans elapsed : {}ms, {} traces, {} spans",new Object[]{watch.getLastTaskTimeMillis(),traces.size(),totalNonTerminalSpansCount});
  }
  watch.start("scanTerminalStatistics");
  for (  Entry<String,ServiceType> param : terminalQueryParams.entrySet()) {
    ServiceType svcType=param.getValue();
    if (!svcType.isRpcClient() && !svcType.isUnknown() && !svcType.isTerminal()) {
      long start=System.currentTimeMillis();
      List<List<TerminalRequest>> terminals=terminalStatisticsDao.selectTerminal(param.getKey(),from,to);
      logger.info("	Fetch terminals of {} : {}ms",param.getKey(),System.currentTimeMillis() - start);
      for (      List<TerminalRequest> terminal : terminals) {
        for (        TerminalRequest t : terminal) {
          if (!endPoints.contains(t.getTo())) {
            t.setToServiceType(ServiceType.UNKNOWN_CLOUD.getCode());
            tree.addTerminal(t);
          }
 else {
          }
        }
      }
    }
  }
  watch.stop();
  logger.info("Fetch terminal statistics elapsed : {}ms",watch.getLastTaskTimeMillis());
  return tree.build();
}
