{
  if (transactionIdList == null) {
    throw new NullPointerException("transactionIdList must not be null");
  }
  if (filter == null) {
    throw new NullPointerException("filter must not be null");
  }
  StopWatch watch=new StopWatch();
  watch.start();
  final Collection<TransactionId> recursiveFilterList=recursiveCallFilter(transactionIdList);
  final List<List<SpanBo>> originalList=this.traceDao.selectAllSpans(recursiveFilterList);
  final List<List<SpanBo>> filterList=filterList2(originalList,filter);
  Set<com.nhn.pinpoint.web.applicationmap.rawdata.LinkStatistics> statisticsData=new HashSet<com.nhn.pinpoint.web.applicationmap.rawdata.LinkStatistics>();
  Map<NodeId,com.nhn.pinpoint.web.applicationmap.rawdata.LinkStatistics> statisticsMap=new HashMap<NodeId,com.nhn.pinpoint.web.applicationmap.rawdata.LinkStatistics>();
  final TimeSeriesStore timeSeriesStore=new TimeSeriesStoreImpl2(range);
  for (  List<SpanBo> transaction : filterList) {
    final Map<Long,SpanBo> transactionSpanMap=new HashMap<Long,SpanBo>(transactionIdList.size());
    for (    SpanBo span : transaction) {
      final SpanBo old=transactionSpanMap.put(span.getSpanId(),span);
      if (old != null) {
        logger.warn("duplicated span found:{}",old);
      }
    }
    for (    SpanBo span : transaction) {
      final Node srcNode=createNode(span,transactionSpanMap);
      final Node destNode=new Node(span.getApplicationId(),span.getServiceType());
      if (!destNode.getServiceType().isRecordStatistics() || destNode.getServiceType().isRpcClient()) {
        continue;
      }
      final ComplexNodeId statId=new ComplexNodeId(srcNode,destNode);
      com.nhn.pinpoint.web.applicationmap.rawdata.LinkStatistics stat=statisticsMap.get(statId);
      if (stat == null) {
        Application source=new Application(srcNode.getName(),srcNode.getServiceType());
        Application dest=new Application(destNode.getName(),destNode.getServiceType());
        stat=new com.nhn.pinpoint.web.applicationmap.rawdata.LinkStatistics(source,dest);
      }
      final short slot=getHistogramSlotTime(span,destNode.getServiceType());
      stat.addSample(destNode.getName(),destNode.getServiceType().getCode(),(short)slot,1);
      statisticsData.add(stat);
      statisticsMap.put(statId,stat);
      timeSeriesStore.add(statId,span.getCollectorAcceptTime(),slot,1L,span.hasException());
      NodeId key=new ComplexNodeId(Node.EMPTY,new Node(span.getApplicationId(),span.getServiceType()));
      timeSeriesStore.add(key,span.getCollectorAcceptTime(),slot,1L,span.hasException());
      addNodeFromSpanEvent(statisticsData,statisticsMap,timeSeriesStore,transactionSpanMap,span);
    }
  }
  for (  com.nhn.pinpoint.web.applicationmap.rawdata.LinkStatistics stat : statisticsData) {
    fillAdditionalInfo(stat);
  }
  ApplicationMap map=new ApplicationMapBuilder().build(statisticsData);
  map.setTimeSeriesStore(timeSeriesStore);
  watch.stop();
  logger.debug("Select filtered application map elapsed. {}ms",watch.getTotalTimeMillis());
  return map;
}
