{
  EventListener eventListner=new EventListener();
  PinpointServerSocket pinpointServerSocket=new PinpointServerSocket(eventListner);
  pinpointServerSocket.setMessageListener(new SimpleListener());
  pinpointServerSocket.bind("127.0.0.1",22234);
  Socket socket=null;
  try {
    socket=new Socket("127.0.0.1",22234);
    sendAndReceiveSimplePacket(socket);
    Assert.assertEquals(eventListner.getCode(),PinpointServerSocketStateCode.RUN_WITHOUT_REGISTER);
    int code=sendAndReceiveRegisterPacket(socket,getParams());
    Assert.assertEquals(eventListner.getCode(),PinpointServerSocketStateCode.RUN);
    sendAndReceiveSimplePacket(socket);
  }
  finally {
    if (socket != null) {
      socket.close();
    }
    if (pinpointServerSocket != null) {
      pinpointServerSocket.close();
    }
  }
}
